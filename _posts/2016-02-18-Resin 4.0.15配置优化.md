---
layout: post
title:  "Resin 4.0.15配置优化"
date:   2016-2-18 星期四  17:17:41 
categories: jekyll update
---

早先说过线上Resin的配置文件中要增加线程池大小、各种timeout参数（resin 4.0.15的默认配置文件肯定没有这些参数，需要另行增加）。

在resin 4.0.10里，有这么一个bug，thread-max的数量设置没有起作用

但后面到了resin 4.0.15应该就修复了。

下面内容会给出背景介绍以及建议配置。

 

###1、背景：###

要综合考虑resin线程池大小、“-Xmx ：JVM最大可用内存”、“-Xms：初始堆大小”、“-Xmn：Young Generation的heap size”参数互相匹配。（JVM有2个GC线程。第一个线程负责回收Heap的Young区。第二个线程在Heap不足时，遍历Heap，将Young 区升级为Older区。Older区的大小等于-Xmx减去-Xmn，不能将-Xms的值设的过大，因为第二个线程被迫运行会降低JVM的性能。）

来避免线上resin服务反复出现以下异常：

	OutOfMemoryError： Java heap space
	OutOfMemoryError： PermGen space

###2、Resin.xml就可以设置JDK参数：###

Resin 4.0已支持把JDK参数加入resin配置文件resin.xml里。

参考resin的帮助文档：

『JDK arguments
Resin 4.0 has moved all JDK arguments into the resin.xml file, in the <jvm-arg> tag. Because the Resin 4.0 watchdog starts each Resin server instance, it can pass the arguments defined in the configuration file to the JVM. By moving the Java arguments to the configuration file, server configuration is easier and more maintainable.
』

###3、建议规则：###

1、 Server端JVM最好将-Xms和-Xmx设为相同值。为了优化GC，最好让-Xmn值约等于-Xmx的1/4。

2、 通过增大 “-XX：PermSize”和“-XX：MaxPermSize”这两个参数来避免出现JVM内存永久保存区域溢出引发Resin的500错误。（郑昀认为，因为线上用了spring+struts，这些框架用到大量动态class，ClassLoader是把这部分内存放在PermGen space里的。而JVM的GC是不会清理PermGen space的。这样容易导致线上应用报告PermGen space内存溢出。）

###4、建议resin配置：###

所以，建议线上部署的Resin 4.0.15的resin.xml中增加如下配置节点：

	<server-default>
	
	    <jvm-arg>-Xms1024m</jvm-arg>
	
	    <jvm-arg>-Xmx1024m</jvm-arg>
	
	    <jvm-arg>-Xmn256m</jvm-arg>
	
	    <jvm-arg>-XX:PermSize=128m</jvm-arg>
	
	<jvm-arg>-XX:MaxPermSize=256m</jvm-arg>
	
	    <thread-max>1024</thread-max>
	
	    <socket-timeout>30s</socket-timeout>
	
	    <keepalive-max>512</keepalive-max>
	
	    <keepalive-timeout>60s</keepalive-timeout>
	
	</server-default>

###5、查看resin 版本###

	root@pts/3 # cd /usr/local/resin/lib

	root@pts/3 # java -classpath ./resin.jar com.caucho.Version
	Resin-4.0.35 (built Tue, 12 Feb 2013 10:05:50 PST)
	Copyright(c) 1998-2012 Caucho Technology.  All rights reserved.