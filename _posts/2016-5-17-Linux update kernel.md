---
layout: post
title:  "Linux update kernel"
date:   2016-5-17 17:06:45 
categories: jekyll update
---

###yum升级系统内核###

1、查看当前系统内核

	root@pts/0 # uname -r
	2.6.32-431.el6.x86_64

2、查看当前grub.conf文件

	root@pts/0 # cat /boot/grub/grub.conf 
	# grub.conf generated by anaconda
	#
	# Note that you do not have to rerun grub after making changes to this file
	# NOTICE:  You have a /boot partition.  This means that
	#          all kernel and initrd paths are relative to /boot/, eg.
	#          root (hd0,0)
	#          kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root
	#          initrd /initrd-[generic-]version.img
	#boot=/dev/vda
	default=0
	timeout=5
	splashimage=(hd0,0)/grub/splash.xpm.gz
	hiddenmenu
	title CentOS (2.6.32-431.el6.x86_64)
	        root (hd0,0)
	        kernel /vmlinuz-2.6.32-431.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap crashkernel=auto LANG=zh_CN.UTF-8 rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet
	        initrd /initramfs-2.6.32-431.el6.x86_64.img

3、升级内核（yum -y update kernel）

	root@pts/0 # yum -y update kernel 
	Loaded plugins: fastestmirror
	Determining fastest mirrors
	 * base: mirrors.yun-idc.com
	 * extras: mirrors.yun-idc.com
	 * updates: mirrors.aliyun.com
	base                                                                                                                            | 3.7 kB     00:00     
	extras                                                                                                                          | 3.4 kB     00:00     
	updates                                                                                                                         | 3.4 kB     00:00     
	updates/primary_db                                                                                                              | 3.9 MB     00:03     
	Setting up Update Process
	Resolving Dependencies
	--> Running transaction check
	---> Package kernel.x86_64 0:2.6.32-573.18.1.el6 will be installed
	--> Processing Dependency: kernel-firmware >= 2.6.32-573.18.1.el6 for package: kernel-2.6.32-573.18.1.el6.x86_64
	--> Processing Dependency: dracut-kernel >= 004-388.el6 for package: kernel-2.6.32-573.18.1.el6.x86_64
	--> Running transaction check
	---> Package dracut-kernel.noarch 0:004-335.el6 will be updated
	---> Package dracut-kernel.noarch 0:004-388.el6 will be an update
	--> Processing Dependency: dracut = 004-388.el6 for package: dracut-kernel-004-388.el6.noarch
	---> Package kernel-firmware.noarch 0:2.6.32-431.el6 will be updated
	---> Package kernel-firmware.noarch 0:2.6.32-573.18.1.el6 will be an update
	--> Running transaction check
	---> Package dracut.noarch 0:004-335.el6 will be updated
	---> Package dracut.noarch 0:004-388.el6 will be an update
	--> Finished Dependency Resolution
	
	Dependencies Resolved
	
	=======================================================================================================================================================
	 Package                                Arch                          Version                                     Repository                      Size
	=======================================================================================================================================================
	Installing:
	 kernel                                 x86_64                        2.6.32-573.18.1.el6                         updates                         30 M
	Updating for dependencies:
	 dracut                                 noarch                        004-388.el6                                 base                           125 k
	 dracut-kernel                          noarch                        004-388.el6                                 base                            26 k
	 kernel-firmware                        noarch                        2.6.32-573.18.1.el6                         updates                         18 M
	
	Transaction Summary
	=======================================================================================================================================================
	Install       1 Package(s)
	Upgrade       3 Package(s)
	
	Total download size: 48 M
	Downloading Packages:
	(1/4): dracut-004-388.el6.noarch.rpm                                                                                            | 125 kB     00:00     
	(2/4): dracut-kernel-004-388.el6.noarch.rpm                                                                                     |  26 kB     00:00     
	(3/4): kernel-2.6.32-573.18.1.el6.x86_64.rpm                                                                                    |  30 MB     00:30     
	(4/4): kernel-firmware-2.6.32-573.18.1.el6.noarch.rpm                                                                           |  18 MB     00:18     
	-------------------------------------------------------------------------------------------------------------------------------------------------------
	Total                                                                                                                  1.0 MB/s |  48 MB     00:49     
	Running rpm_check_debug
	Running Transaction Test
	Transaction Test Succeeded
	Running Transaction
	  Updating   : kernel-firmware-2.6.32-573.18.1.el6.noarch                                                                                          1/7 
	  Updating   : dracut-004-388.el6.noarch                                                                                                           2/7 
	  Updating   : dracut-kernel-004-388.el6.noarch                                                                                                    3/7 
	  Installing : kernel-2.6.32-573.18.1.el6.x86_64                                                                                                   4/7 
	  Cleanup    : dracut-kernel-004-335.el6.noarch                                                                                                    5/7 
	  Cleanup    : dracut-004-335.el6.noarch                                                                                                           6/7 
	  Cleanup    : kernel-firmware-2.6.32-431.el6.noarch                                                                                               7/7 
	  Verifying  : dracut-kernel-004-388.el6.noarch                                                                                                    1/7 
	  Verifying  : dracut-004-388.el6.noarch                                                                                                           2/7 
	  Verifying  : kernel-firmware-2.6.32-573.18.1.el6.noarch                                                                                          3/7 
	  Verifying  : kernel-2.6.32-573.18.1.el6.x86_64                                                                                                   4/7 
	  Verifying  : dracut-004-335.el6.noarch                                                                                                           5/7 
	  Verifying  : kernel-firmware-2.6.32-431.el6.noarch                                                                                               6/7 
	  Verifying  : dracut-kernel-004-335.el6.noarch                                                                                                    7/7 
	
	Installed:
	  kernel.x86_64 0:2.6.32-573.18.1.el6                                                                                                                  
	
	Dependency Updated:
	  dracut.noarch 0:004-388.el6               dracut-kernel.noarch 0:004-388.el6               kernel-firmware.noarch 0:2.6.32-573.18.1.el6              
	
	Complete!

4、再次查看升级过后的grub.conf

	root@pts/0 # cat /boot/grub/grub.conf 
	# grub.conf generated by anaconda
	#
	# Note that you do not have to rerun grub after making changes to this file
	# NOTICE:  You have a /boot partition.  This means that
	#          all kernel and initrd paths are relative to /boot/, eg.
	#          root (hd0,0)
	#          kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root
	#          initrd /initrd-[generic-]version.img
	#boot=/dev/vda
	default=0
	timeout=5
	splashimage=(hd0,0)/grub/splash.xpm.gz
	hiddenmenu
	title CentOS (2.6.32-573.18.1.el6.x86_64)
	        root (hd0,0)
	        kernel /vmlinuz-2.6.32-573.18.1.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap crashkernel=auto LANG=zh_CN.UTF-8 rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet
	        initrd /initramfs-2.6.32-573.18.1.el6.x86_64.img
	title CentOS (2.6.32-431.el6.x86_64)
	        root (hd0,0)
	        kernel /vmlinuz-2.6.32-431.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap crashkernel=auto LANG=zh_CN.UTF-8 rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet
	        initrd /initramfs-2.6.32-431.el6.x86_64.img

5、修改grub的主配置文件/etc/grub.conf，设置default=0，表示第一个title下的内容为默认启动的kernel（一般新安装的内核在第一个位置）

	root@pts/0 # cat /etc/grub.conf 
	# grub.conf generated by anaconda
	#
	# Note that you do not have to rerun grub after making changes to this file
	# NOTICE:  You have a /boot partition.  This means that
	#          all kernel and initrd paths are relative to /boot/, eg.
	#          root (hd0,0)
	#          kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root
	#          initrd /initrd-[generic-]version.img
	#boot=/dev/vda
	default=0
	timeout=5
	splashimage=(hd0,0)/grub/splash.xpm.gz
	hiddenmenu
	title CentOS (2.6.32-573.18.1.el6.x86_64)
	        root (hd0,0)
	        kernel /vmlinuz-2.6.32-573.18.1.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap crashkernel=auto LANG=zh_CN.UTF-8 rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet
	        initrd /initramfs-2.6.32-573.18.1.el6.x86_64.img
	title CentOS (2.6.32-431.el6.x86_64)
	        root (hd0,0)
	        kernel /vmlinuz-2.6.32-431.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root rd_NO_LUKS rd_NO_MD rd_LVM_LV=VolGroup/lv_swap crashkernel=auto LANG=zh_CN.UTF-8 rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet
	        initrd /initramfs-2.6.32-431.el6.x86_64.img


6、重启系统reboot now

	root@pts/0 # reboot 
	
	Broadcast message from root@chaichuan
	        (/dev/pts/0) at 18:55 ...
	
	The system is going down for reboot NOW!

7、再次查看当前内核

	root@pts/0 # uname -r
	2.6.32-573.18.1.el6.x86_64

已经从

	2.6.32-431.el6.x86_64

升级到

	2.6.32-573.18.1.el6.x86_64

###升级带aufs模块的3.10内核（可选）###

1、修改yum源后在yum升级

	[root@localhost ~]# vim /etc/yum.repos.d/hop5.repo
	
	[hop5]
	name=www.hop5.in Centos Repository
	baseurl=http://www.hop5.in/yum/el6/
	gpgcheck=0
	gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-HOP5
	
	
	 
	[root@localhost ~]# yum -y install kernel-ml-aufs kernel-ml-aufs-devel

2、修改grub的主配置文件/etc/grub.conf，设置default=0，表示第一个title下的内容为默认启动的kernel（一般新安装的内核在第一个位置）。

3、重启系统reboot now,

4、然后执行uname -r,查看是否已经是3.10内核!

	[root@localhost ~]# uname -r
	3.10.5-3.el6.x86_64

5、执行grep aufs /proc/filesystems,查看内核是否支持aufs!

	[root@localhost ~]# grep aufs /proc/filesystems
	nodev   aufs